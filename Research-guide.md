# Azure VM/VMSS에 Telegraf 설치 및 Azure Monitor 대시보드 구성 가이드

이 가이드는 Azure VM 또는 VMSS에 **Telegraf 에이전트**를 설치하고, 수집된 메트릭 데이터를 **Azure Monitor**로 보내어 대시보드에서 시각화하는 과정을 단계별로 설명합니다. 특히 GPU 및 InfiniBand를 사용하는 HPC/AI 워크로드 모니터링을 예로 들어, 필요한 사전 준비부터 설치, 구성, 인증 설정, 대시보드 생성, 그리고 문제 해결 팁까지 포괄합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 

## 전제 조건 (Prerequisites)
이 가이드를 시작하기 전에 다음 조건을 확인하세요:

- **Azure 구독 권한**: Azure Monitor 커스텀 메트릭을 사용하려면 구독에 `Microsoft.Insights` 리소스 공급자를 등록해야 합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 또한 Azure VM/VMSS에 관리형 ID를 할당하고 적절한 권한을 부여할 수 있는 **소유자 또는 관리자 권한**이 필요합니다.  
- **대상 Azure VM/VMSS 준비**: 모니터링 대상은 Azure VM 또는 VMSS 인스턴스여야 합니다. GPU/InfiniBand 모니터링을 위해서는 **H 시리즈 또는 N 시리즈** 등의 GPU/RDMA 지원 VM 사이즈를 사용합니다. 예시에서는 *Standard_ND96asr_v4* VM (N 시리즈, 8×A100 GPU)와 **Ubuntu HPC 22.04 이미지**를 사용합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 해당 이미지는 NVIDIA GPU 드라이버, CUDA 툴킷, Mellanox InfiniBand 드라이버가 미리 설치되어 있습니다. 만약 다른 OS나 이미지를 사용한다면 **NVIDIA GPU 드라이버와 CUDA**, **InfiniBand 드라이버**(OFED 패키지 등)를 수동으로 설치해야 합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
- **네트워크 접근**: 대상 VM이 Azure Monitor에 데이터를 전송할 수 있도록 인터넷 액세스 또는 필요한 **Azure 엔드포인트**(`*.monitoring.azure.com`)에 대한 네트워크 접근이 허용되어야 합니다. 방화벽 또는 NSG가 있다면 Azure Monitor로의 아웃바운드 통신을 허용하세요.  
- **Telegraf 설치 권한**: VM에 SSH 또는 관리자 권한으로 접속할 수 있어야 하며, 패키지를 다운로드/설치할 수 있어야 합니다.

위 조건을 충족했다면, 이제 본격적으로 단계별 설정을 진행합니다.

---

## 단계별 설정 가이드

1. **Azure Monitor 커스텀 메트릭 사용 준비** (리소스 공급자 등록 및 권한 설정)  
   - *Microsoft.Insights 등록*: Azure Monitor의 커스텀 메트릭 기능을 사용하기 위해 먼저 Azure 구독에 **`Microsoft.Insights` 리소스 공급자**를 등록해야 합니다. Azure 포털에서 구독 -> *리소스 공급자* 메뉴로 이동하여 `Microsoft.Insights`를 찾아 **등록(Register)**을 클릭합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 혹은 Azure CLI를 사용할 경우 다음 명령을 실행합니다:  
     ```bash
     az provider register --namespace Microsoft.Insights
     ```  
     이 작업은 한 번만 수행하면 되며, 완료 후 VM의 커스텀 메트릭 수집이 가능해집니다.  
   - *“Monitoring Metrics Publisher” 역할 할당*: Telegraf가 수집한 메트릭을 Azure Monitor에 쓰기 위해서는 **Metrics 출력 대상 리소스에 대한 권한**이 필요합니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). Azure에서는 이 목적으로 **“Monitoring Metrics Publisher”**라는 역할을 제공하며, 필요한 경우 **VM 리소스 자신에 이 역할을 할당**해야 합니다[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure). 예를 들어 시스템 할당 관리형 ID(System-Assigned Managed Identity)를 사용할 경우, 해당 VM의 **Access Control(IAM)** 설정에서 해당 ID에게 Monitoring Metrics Publisher 역할을 부여하세요[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure). 이 역할이 없으면 Telegraf가 메트릭 전송 시 `'Microsoft.Insights/Metrics/write'` 권한 오류가 발생합니다[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure). 참고로 *Contributor*나 *Owner* 권한만으로는 이 작업이 허용되지 않으므로 꼭 전용 역할을 추가해야 합니다[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure).
   - **(선택 사항) 서비스 주체 방식**: 만약 VM에 관리형 ID 사용이 불가능하거나 원하지 않는 경우, **Azure AD 애플리케이션(서비스 주체)**를 만들어 Telegraf에 인증 정보를 제공할 수 있습니다. 이 경우 Azure AD 테넌트 ID, 클라이언트 ID, 클라이언트 비밀 값을 준비하고, 추후 Telegraf 설정 시 이 값을 환경변수 `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`로 설정합니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). 이 서비스 주체에도 위의 Monitoring Metrics Publisher 역할을 대상 리소스에 할당해야 하는 것을 잊지 마세요[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). 일반적으로 Azure VM 내에서 실행할 때는 **관리형 ID (MSI) 사용이 가장 간편하고 권장되는 인증 방식**입니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md).

2. **VM/VMSS에 관리형 ID 활성화 (Azure 인증 설정)**  
   위 1단계에서 권장한 **시스템 할당형 Managed Identity**를 VM 또는 VMSS에 활성화합니다.  
   - *Azure VM의 관리형 ID 활성화*: Azure 포털에서 해당 VM으로 이동한 뒤, **정체성(Identity)** 메뉴를 선택합니다. **시스템 할당 관리 ID**를 **사용 함(On)**으로 전환하고 저장합니다. 이렇게 하면 VM에 연결된 Azure AD 객체가 생성됩니다.  
   - *Azure VMSS의 관리형 ID 활성화*: VMSS의 경우, Azure 포털에서 스케일셋 -> **정체성** -> 시스템 할당 ID **사용 함**으로 설정합니다. 그러면 모든 인스턴스에 공통으로 적용되는 ID가 발급됩니다.  
   - *역할 할당 확인*: 관리형 ID를 활성화한 후, **Access Control(IAM)** 화면으로 가서 해당 ID에 **Monitoring Metrics Publisher** 역할이 부여되어 있는지 확인합니다 (1단계에서 이미 했다면 완료). 관리형 ID 사용 시 Telegraf는 별도의 자격증명 정보 없이도 이 ID를 통해 Azure에 인증합니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md).  
   - > **참고:** 이 가이드에서는 Managed Identity를 사용한 인증을 다룹니다. Managed Identity는 Azure VM 환경에서 **별도 키나 비밀번호 없이 안전하게 Telegraf가 Azure Monitor에 접근**하도록 해줍니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). 필요에 따라 사용자 할당 관리형 ID나 서비스 주체를 사용할 수 있으나, 구현 복잡성이 증가하므로 권장되지 않습니다 (주로 특정 리소스에Cross-Resource 메트릭 전송 시에만 사용). 기본적으로 Telegraf Azure Monitor 출력 플러그인은 **가장 먼저 관리형 ID를 이용해 인증**을 시도합니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md).

3. **Telegraf 에이전트 설치 (Azure VM/VMSS 내부)**  
   이제 모니터링 대상 VM 또는 VMSS 인스턴스 내에 Telegraf를 설치합니다. Linux(Ubuntu 22.04 기준) 환경에서 설치 및 기본 구성 방법은 다음과 같습니다:
   - **Telegraf 설치 스크립트 사용**: Microsoft HPC 블로그에서는 설치 과정을 자동화한 스크립트를 제공하고 있습니다. 이 스크립트는 Telegraf 최신 버전을 설치하고, GPU 및 InfiniBand 모니터링에 필요한 입력 플러그인(NVIDIA SMI, InfiniBand)을 설정하며, Azure Monitor 출력 설정까지 한 번에 적용해줍니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). Ubuntu 22.04 환경에서 아래 명령을 차례로 실행하세요:  
     ```bash
     wget https://raw.githubusercontent.com/vinil-v/gpu-ib-monitoring/refs/heads/main/scripts/gpu-ib-mon_setup.sh -O gpu-ib-mon_setup.sh  
     chmod +x gpu-ib-mon_setup.sh  
     ./gpu-ib-mon_setup.sh  
     ```  
     위 스크립트를 실행하면 Telegraf 에이전트가 설치됨과 동시에 `/etc/telegraf/telegraf.conf` 설정파일이 HPC 모니터링에 맞게 구성됩니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323)[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 스크립트는 Ubuntu HPC 이미지를 가정하여 작성되었으므로, **Ubuntu 22.04에서만 공식적으로 테스트**되었다는 점을 유의하세요[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
   - **수동 설치 (옵션)**: 만약 스크립트를 사용할 수 없는 환경이라면, Telegraf를 수동으로 설치할 수도 있습니다. Telegraf는 InfluxData에서 제공하는 패키지로, Debian/Ubuntu의 경우 APT 저장소를 추가한 뒤 `apt-get install telegraf`로 설치 가능합니다. 설치 후 **`/etc/telegraf/telegraf.conf`** 설정 파일을 열어 필요한 입력(`[[inputs.nvidia_smi]]`, `[[inputs.infiniband]]` 등)과 출력(`[[outputs.azure_monitor]]`) 플러그인 설정을 직접 추가해야 합니다. (이 부분은 다음 단계에서 자세히 설명합니다.) Windows VM의 경우에도 MSI 설치 파일을 제공하며, GPU 모니터링을 위해 PowerShell 스크립트(`gpumon-win.ps1`)를 활용한 설치법이 별도로 존재합니다[4](https://github.com/vinil-v/gpu-monitoring).  
   - **드라이버 확인**: (GPU/IB 모니터링 시) NVIDIA GPU와 InfiniBand 장치 드라이버가 제대로 설치되어 있어야 합니다. Ubuntu HPC 이미지를 썼다면 이 단계는 이미 충족되어 있습니다. 커스텀 이미지의 경우, NVIDIA의 CUDA 드라이버 설치 및 Mellanox OFED(Libibverbs) 설치를 사전에 완료하세요[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
   - **Telegraf 서비스 시작**: 스크립트를 이용했다면, Telegraf 데몬(service)이 자동으로 시작되었을 수 있습니다. 그렇지 않은 경우 수동으로 **서비스 시작/활성화**가 필요합니다:  
     ```bash
     sudo systemctl start telegraf
     sudo systemctl enable telegraf
     ```  
     이로써 Telegraf 에이전트가 백그라운드에서 실행되며 메트릭 수집을 시작합니다.

4. **Telegraf 구성 및 Azure Monitor 연동 확인**  
   이제 Telegraf가 VM 내에서 수집한 메트릭을 Azure Monitor로 보낼 수 있도록 구성되었는지 확인하고, 필요한 설정을 조정하겠습니다.  
   - **Azure Monitor 출력 설정 확인**: Telegraf 설정 파일(`telegraf.conf`)에 Azure Monitor 출력 플러그인이 올바르게 설정되어 있는지 확인합니다. 스크립트를 사용했다면 이미 `[[outputs.azure_monitor]]` 블록이 추가되어 있을 것입니다. 특히 **region**이나 **resource_id** 등이 비어 있어도, Azure VM 내부에서는 **인스턴스 메타데이터 서비스**를 통해 현재 VM의 지역 및 리소스ID를 자동으로 인식하므로 수동 설정은 보통 필요 없습니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). 기본 namespace 접두사는 `"Telegraf/"`로 설정되어 있어, 각 input 플러그인별로 `Telegraf/<plugin_name>` 형태의 메트릭 네임스페이스가 생성됩니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md).  
     - **인증 방식 확인**: 관리형 ID를 활성화했다면 추가적인 자격증명 설정은 필요하지 않습니다. Telegraf 에이전트는 Azure 환경에서 실행 중일 때 자동으로 **MSI 토큰**을 획득하여 인증 시도합니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). (서비스 주체를 사용 중이라면, 해당 서비스 주체의 Tenant ID/Client ID/Secret을 환경변수로 설정하거나, `telegraf.conf` 내에 환경변수를 불러오도록 `env_interval` 설정을 해야 합니다. 또한 이 경우 위에서 언급한 역할 할당이 제대로 되었는지 재확인하십시오.)  
     - **수집 대상 메트릭 설정**: HPC 워크로드에서 중요한 메트릭을 수집하도록 Telegraf **입력 플러그인**이 설정되어야 합니다. NVIDIA GPU 정보를 위해 `[[inputs.nvidia_smi]]` 플러그인이, InfiniBand HCA 정보를 위해 `[[inputs.infiniband]]` 플러그인이 사용됩니다. 스크립트는 이러한 입력 플러그인을 활성화하여 GPU **이용률**, **메모리 사용량**, **온도**부터 **InfiniBand 포트 상태**, **전송량**, **에러 카운터** 등을 주기적으로 수집하도록 구성합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323)[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). (필요에 따라 추가로 CPU, 메모리 등의 기본 시스템 메트릭도 Telegraf로 수집할 수 있으나, Azure Monitor가 이미 제공하므로 중복 수집은 피하는 것이 좋습니다.)  
     - **Flush 간격**: Azure Monitor의 메트릭 수집 해상도는 **1분**이므로, Telegraf 출력 플러그인은 수집된 데이터를 1분 단위로 집계하여 전송합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). Telegraf 기본 flush 주기가 10초라도 Azure Monitor 출력 시에는 자동으로 1분에 한 번씩 전송되도록 동작합니다.  
   - **구성 테스트 (Telegraf)**: 설정이 완료되었다면 **Telegraf 구성 테스트**를 수행해 봅니다. 다음 명령을 실행하여 설정된 입력 메트릭들이 잘 수집되고 출력으로 준비되는지 확인합니다:  
     ```bash
     sudo telegraf --config /etc/telegraf/telegraf.conf --test
     ```  
     이 명령은 현재 설정으로 메트릭 수집을 1회 수행한 결과를 화면에 출력합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 각 플러그인별로 수집된 메트릭 항목들이 보이면 성공입니다. (여기서 출력되는 값들은 실제 Azure Monitor로 전송되지는 않으며, 단지 내부 수집 결과를 검증하는 용도입니다.) 만약 오류 메시지가 나타나면, 해당 플러그인의 설정이나 환경을 점검해야 합니다. 예를 들어 GPU 드라이버 관련 에러가 있으면 NVIDIA SMI 실행 여부를 확인하고, 인증 관련 에러(`Metrics/write permission`)가 있으면 앞서 **역할 할당**이 누락되지 않았는지 확인하세요.  
   - **Telegraf 서비스 재시작**: 테스트가 완료되었으면, 변경된 설정이 반영되도록 Telegraf 데몬을 다시 시작합니다: `sudo systemctl restart telegraf`. 이후 에이전트는 설정된 대로 메트릭을 수집하여 Azure Monitor로 보내게 됩니다.

5. **Azure Monitor에서 대시보드 구성 및 메트릭 시각화**  
   이제 VM에서 올라오는 커스텀 메트릭을 Azure Portal에서 확인하고, 원하는 방식으로 **대시보드**에 표시해 보겠습니다.  
   - **메트릭 확인 (Azure Portal)**: Azure Portal에서 **Azure Monitor -> 메트릭(Metrics)** 메뉴로 이동합니다. Scope(대상)를 모니터링 중인 VM으로 설정하세요. 그 후 **Metric Namespace** 드롭다운을 열어보면, 일정 시간이 지난 후 `Telegraf/...`로 시작하는 네임스페이스들이 나타납니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323)[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure). 예를 들어, GPU 메트릭의 경우 `Telegraf/nvidia-smi` 네임스페이스가, InfiniBand 메트릭의 경우 `Telegraf/infiniband` 네임스페이스가 생성되어 있습니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
   - **메트릭 차트 생성**: 먼저 GPU 관련 지표를 하나 보여보겠습니다. **Metric Namespace**에서 `Telegraf/nvidia-smi`를 선택하면, 그 아래 **Metric** 목록에 GPU 이용률(`utilization`), GPU 메모리 사용량(`memory_used`), GPU 온도(`temperature`) 등 여러 항목이 나타납니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 이 중 *Memory Used* 메트릭을 선택해 봅니다. Aggregation(집계)는 기본값인 Average로 두면, 1분 간격의 평균 메모리 사용량 추이가 차트로 표시됩니다 (GPU 메트릭은 실시간성이 중요하다면 **Max** 값으로 볼 수도 있습니다). 여러 GPU가 있는 VM의 경우 **필터/분할(Filters/Splitting)** 옵션을 사용하여 특정 GPU 인덱스별로 분리해서 볼 수 있습니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
   - **InfiniBand 메트릭 차트**: 다음으로 InfiniBand 관련 메트릭도 확인해보겠습니다. Metric Namespace를 `Telegraf/infiniband`로 선택하면, **port_xmit_data**, **port_rcv_data**(포트별 송수신 바이트), **link_downed**(링크 다운 발생 횟수), **link_error_recovery** 등의 지표가 보입니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 예시로 *Link Flap* 이슈를 모니터링하기 위해 **link_downed** 메트릭을 선택해 보겠습니다. 이 경우 집계 유형을 **Max** 또는 **Min**으로 선택하는 것이 적절합니다. (참고로 *Count*로 집계하면 간헐적으로 잘못된 값이 표시되는 알려진 이슈가 있으므로 Max/Min을 사용합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).) 이렇게 하면 1분 간격으로 InfiniBand 링크가 다운된 횟수를 정확하게 모니터링할 수 있습니다. 마찬가지로 여러 InfiniBand 포트가 있다면 포트 ID 차원으로 분할해 개별 포트의 상태를 추적할 수 있습니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
   - **커스텀 대시보드 구성**: Azure Monitor의 메트릭 차트를 **대시보드**에 고정(Pin)하여 지속적으로 모니터링하기 쉽게 만들 수 있습니다. 방금 생성한 GPU 메모리 사용량 차트와 InfiniBand link_downed 차트를 각각 화면 상단의 📌**Pin to dashboard** 버튼을 눌러 새로운 대시보드에 추가합니다. “새 대시보드로 핀(Pin to New Dashboard)” 옵션을 선택하여 적절한 이름의 대시보드를 생성하세요. 이렇게 하면 Azure Portal의 *대시보드* 섹션에 사용자 지정 모니터링 대시보드가 생성됩니다. 이 대시보드에는 실시간으로 갱신되는 GPU 및 InfiniBand 메트릭 그래프가 표시되며, 필요에 따라 크기를 조정하거나 위치를 배치할 수 있습니다. 추가로, VM의 기본 CPU, 메모리, 네트워크 메트릭도 **Metrics** 창에서 선택 후 동일하게 핀하여 한 화면에서 종합적인 자원 사용량을 모니터링할 수 있습니다.  
   - **여러 리소스 통합**: 만약 여러 VM 또는 VMSS 인스턴스들의 메트릭을 한 곳에서 보고 싶다면, Azure Monitor의 **Workbooks(작업 책)** 기능을 사용하거나, Log Analytics Workspace에 커스텀 메트릭을 보내는 방안을 고려할 수 있습니다. 그러나 단일 VM/VMSS 기준으로는 앞서 만든 Azure 대시보드만으로도 충분히 통합된 모니터링 뷰를 얻을 수 있습니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323).  
   - **예시 대시보드 화면**: (예시로, GPU 사용량과 메모리, InfiniBand 에러를 한눈에 볼 수 있는 대시보드 구성을 할 수 있습니다. 여기에는 GPU0~7 번까지의 메모리 사용률 막대그래프, InfiniBand 포트별 에러 카운터 테이블, GPU 전체 사용률 추이 라인차트 등을 배치하면 유용합니다.)  

---

## 문제 해결 및 베스트 프랙티스 (Troubleshooting & Best Practices)

마지막으로, 설정 과정에서 마주칠 수 있는 일반적인 문제들과 원활한 모니터링을 위한 권장 사항을 정리합니다:

- **메트릭이 Azure Portal에 보이지 않을 때**: Telegraf를 시작한 후 커스텀 메트릭 네임스페이스(`Telegraf/...`)가 바로 보이지 않을 수 있습니다. **최초 메트릭이 수집되어 전송된 후 나타나기까지 몇 분 정도 지연**될 수 있으니 잠시 기다린 후 다시 확인하세요[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure). 그래도 안 보인다면 Telegraf 설정이나 권한에 이슈가 있을 수 있습니다. VM의 **시스템 로그(journal)**에서 Telegraf 서비스 로그(`journalctl -u telegraf`)를 확인하여 오류 메시지가 있는지 점검합니다. 인증 실패나 권한 오류가 있다면 앞서 **Managed Identity 및 역할 할당** 부분이 제대로 되었는지 재검토하세요.  
- **인증 및 권한 오류**: `AuthenticationFailed` 또는 권한 관련 에러가 Telegraf 로그에 나타나는 경우, 대개 **Monitoring Metrics Publisher 역할 누락**이 원인입니다[3](https://stackoverflow.com/questions/55524702/custom-metrics-against-a-vm-in-azure). Azure Portal에서 VM 리소스의 **액세스 제어(IAM)**에 가서 올바른 주체(시스템 ID 또는 서비스 주체)에 해당 역할이 부여되어 있는지 확인하고, 누락 시 추가하세요. 또한 서비스 주체 인증을 사용한다면 **환경변수 설정**이 Telegraf 프로세스에 전달되었는지 (예: `/etc/default/telegraf` 파일에 추가) 확인해야 합니다.  
- **Azure 지역 및 프리뷰 상태**: Azure Monitor의 커스텀 메트릭 API는 현재 일부 Azure 지역에서만 사용 가능하거나 **미리보기(Preview)** 상태일 수 있습니다[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md). 일반적으로 전세계 주요 리전에 지원되고 있으나, 혹시 메트릭이 전송되지 않는다면 VM의 지역이 지원되는지 확인해보세요. 필요하면 `[[outputs.azure_monitor]]` 설정에 수동으로 `region` 값을 지정할 수 있습니다 (예: `region = "koreacentral"` 등).  
- **Telegraf 버전 호환성**: 이 가이드에서는 Telegraf **1.15** 버전 기준의 설정을 활용했습니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 최신 Telegraf를 사용할 경우 설정 파일 형식이나 플러그인 옵션이 약간 다를 수 있으므로, 공식 Telegraf 문서와 샘플 설정(`sample.conf`)을 참조하세요. 특히 Azure Monitor 출력 플러그인의 경우 향후 버전에서 구성이 변동될 수 있습니다. 가급적 **공식 문서**나 InfluxData의 GitHub 리포지토리의 README를 확인하여 최신 정보를 반영하세요.  
- **HPC/AI 워크로드 모니터링 팁**: GPU 및 InfiniBand 모니터링 시에는 **온도**, **메모리 사용량**, **에러** 등의 지표에 경고 임계값을 설정해 두는 것이 좋습니다. 예를 들어, GPU 온도가 일정 수준 이상 올라가면 알림을 받을 수 있도록 Azure Monitor 경고 규칙을 설정하거나, InfiniBand의 포트 에러(`symbol_error` 등)가 증가하면 대응할 수 있게 알림을 구성하세요. 이러한 지표들은 성능 튜닝과 장애 예방에 중요합니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323). 또한 **성능 최적화 및 용량 계획**을 위해, 일정 기간의 데이터를 Azure Monitor에서 Export하거나 Workbooks로 분석하여 자원 사용 패턴을 파악하는 것이 도움이 됩니다.  
- **시스템 자원 부하**: Telegraf 에이전트 자체는 경량이지만, GPU나 IB 통계를 수집할 때 약간의 CPU 사용과 디스크 I/O가 발생할 수 있습니다. 일반적으로 무시해도 좋을 수준이지만, 매우 민감한 HPC 작업 중이라면 Telegraf 수집 주기나 동작 시간이 작업에 영향을 주지 않도록 **수집 간격(interval)**을 조정할 수 있습니다 (기본 10초인 입력 플러그인 수집 주기를 30초나 60초로 늘리는 등 조정 가능). 다만 Azure Monitor 전송은 어차피 1분에 한 번 이루어지므로, 지나치게 짧은 수집 간격은 의미가 없습니다.  
- **업데이트 및 유지보수**: GPU 드라이버나 InfiniBand 드라이버를 업데이트하면 그에 대응하는 Telegraf 입력 플러그인이 오류를 일으키지 않는지 확인하세요. Telegraf 구성은 일반 텍스트 파일로 존재하므로, **백업을 잘 받아두고 변경 관리**를 해두면 좋습니다. 또한 새로운 VM을 배포하거나 VMSS에 인스턴스가 추가될 때 이 설정이 반영되도록 **이미지를 커스터마이징**하거나 **확장(Extension)** 스크립트를 사용하는 것도 고려하세요. 마지막으로, Azure Monitor에 쌓이는 **커스텀 메트릭 데이터에 대한 비용**도 염두에 두세요. Azure는 일정량 이상의 커스텀 메트릭에 대해 요금을 청구할 수 있으므로, 필요한 메트릭만 선별하여 송신하고 너무 세분화된 차원(dimensions)을 남발하지 않는 것이 좋습니다 (Azure Monitor는 메트릭당 최대 10개의 태그/차원만 지원함[2](https://github.com/influxdata/telegraf/blob/master/plugins/outputs/azure_monitor/README.md)).  

이상으로 Azure VM/VMSS에 Telegraf를 설치하고 Azure Monitor로 메트릭을 보내서 대시보드로 시각화하는 방법을 살펴보았습니다. **이 가이드를 따르면 GPU 및 InfiniBand와 같은 특수 자원에 대한 모니터링 공백을 메우고, Azure Monitor를 통해 실시간으로 성능 상태를 파악**할 수 있을 것입니다[1](https://techcommunity.microsoft.com/blog/azurehighperformancecomputingblog/monitoring-hpc--ai-workloads-on-azure-hn-vms-using-telegraf-and-azure-monitor-gp/4407323)